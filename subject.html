<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mystery Game: Who Threw a Cake at the Monalisa?</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDK (ESM) + Auth -->
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBFq-99bZSsy3h1qNy7irJZe7Z0OpZ9s4k",
    authDomain: "st-grade-9e67f.firebaseapp.com",
    projectId: "st-grade-9e67f",
    storageBucket: "st-grade-9e67f.firebasestorage.app",
    messagingSenderId: "481985157615",
    appId: "1:481985157615:web:a40a8623938815ad283e1a",
    measurementId: "G-GN02CWDQ91"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
        // Auth: anonymous sign-in
        const auth = getAuth(app);
        window.firebaseAuth = auth;
        window.firebaseUser = null;
        signInAnonymously(auth).catch(e => console.error('Anonymous sign-in failed:', e));
        onAuthStateChanged(auth, (user) => {
          window.firebaseUser = user || null;
          const el = document.getElementById('firebaseStatus');
          if (user && el) {
            el.textContent = `ğŸŸ¢ Connected (UID: ${user.uid.slice(0,6)}â€¦)`;
            el.classList.remove('firebase-disconnected');
            el.classList.add('firebase-connected');
          }
          if (user && typeof initializeFirebase === 'function' && !window.__initOnce) {
            window.__initOnce = true;
            initializeFirebase();
          }
        });

        // Expose Firebase helpers globally for non-module scripts
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebasePush = push;
        window.firebaseOnValue = onValue;
        window.firebaseSet = set;
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .progress-bar { transition: width 0.5s ease; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px);} to { opacity: 1; transform: translateY(0);} }
        .canvas-container { border: 3px solid #e5e7eb; border-radius: 12px; background: white; }
        .color-btn { width: 40px; height: 40px; border-radius: 50%; border: 3px solid white; cursor: pointer; transition: transform 0.2s; }
        .color-btn:hover { transform: scale(1.1); }
        .color-btn.active { border-color: #374151; transform: scale(1.2); }
        .clue-item { transition: all 0.3s ease; cursor: pointer; }
        .clue-item:hover { background: #f3f4f6; transform: translateX(5px); }
        .suspect-card { transition: all 0.3s ease; cursor: pointer; }
        .suspect-card:hover { transform: scale(1.02); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .suspect-card.selected { border-color: #10b981; background: #ecfdf5; }
        .firebase-status { position: fixed; top: 20px; right: 20px; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 500; z-index: 1000; }
        .firebase-connected { background: #10b981; color: white; }
        .firebase-disconnected { background: #ef4444; color: white; }
        .new-share-notification { animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.7} }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Firebase Connection Status -->
    <div id="firebaseStatus" class="firebase-status firebase-disconnected">ğŸ”´ Connecting to Firebase (Anonymous)â€¦</div>

    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8 fade-in">
            <h1 class="text-4xl font-bold text-white mb-4">ğŸ¨ Mystery at the Museum</h1>
            <p class="text-xl text-white/90">Who Threw a Cake at the Monalisa?</p>
            <div class="mt-6 bg-white/20 rounded-full h-3 max-w-md mx-auto">
                <div id="progressBar" class="progress-bar bg-white rounded-full h-3" style="width: 0%"></div>
            </div>
            <p class="text-white/80 mt-2">Progress: <span id="progressText">0/7</span> sections completed</p>
        </div>

        <!-- Navigation -->
        <div class="flex flex-wrap justify-center gap-4 mb-8">
            <button onclick="showSection('story')" class="nav-btn bg-white/20 hover:bg-white/30 text-white px-6 py-3 rounded-lg font-medium transition-all">ğŸ“– Story</button>
            <button onclick="showSection('vocabulary')" class="nav-btn bg-white/20 hover:bg-white/30 text-white px-6 py-3 rounded-lg font-medium transition-all">ğŸ“š Vocabulary</button>
            <button onclick="showSection('questions')" class="nav-btn bg-white/20 hover:bg-white/30 text-white px-6 py-3 rounded-lg font-medium transition-all">â“ Questions</button>
            <button onclick="showSection('grammar')" class="nav-btn bg-white/20 hover:bg-white/30 text-white px-6 py-3 rounded-lg font-medium transition-all">ğŸ“ Grammar</button>
            <button onclick="showSection('clues')" class="nav-btn bg-white/20 hover:bg-white/30 text-white px-6 py-3 rounded-lg font-medium transition-all">ğŸ” Clues</button>
            <button onclick="showSection('sketch')" class="nav-btn bg-white/20 hover:bg-white/30 text-white px-6 py-3 rounded-lg font-medium transition-all">ğŸ¨ Sketch</button>
            <button onclick="showSection('solve')" class="nav-btn bg-white/20 hover:bg-white/30 text-white px-6 py-3 rounded-lg font-medium transition-all">ğŸ•µï¸ Solve</button>
        </div>

        <!-- ===== Story Section ===== -->
        <div id="storySection" class="section bg-white rounded-2xl p-8 shadow-2xl card-hover mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">ğŸ“– The Mystery Story</h2>
            <div class="space-y-6">
                <div class="bg-blue-50 p-6 rounded-xl border-l-4 border-blue-500">
                    <h3 class="font-semibold text-lg mb-3">ğŸ›ï¸ The Crime Scene</h3>
                    <p class="text-gray-700 leading-relaxed">Last Saturday, someone threw a cake at the Monalisa in the Botero Museum in Bogota, Colombia. There were four eyewitnesses. What did they say? Read the following, and find the criminal.</p>
                </div>
                <div class="bg-green-50 p-6 rounded-xl border-l-4 border-green-500">
                    <h3 class="font-semibold text-lg mb-3">ğŸ‘© Ann Jones, a visitor</h3>
                    <p class="text-gray-700 leading-relaxed">I was looking at the Monalisa, and someone threw a cake at the painting. I turned around and saw an old man. He was standing in front of a wheelchair. I'm about 170 cm tall, and he was a little taller than me.</p>
                    <div class="mt-4 bg-white p-4 rounded-lg border border-green-300">
                        <label class="block text-sm font-medium text-green-700 mb-2">âœï¸ Write a clue from Ann's testimony:</label>
                        <input type="text" id="annClue" class="w-full p-2 border border-green-300 rounded focus:ring-2 focus:ring-green-500" placeholder="ì˜ˆ: The suspect was taller than 170cm..." />
                        <button onclick="addWitnessClue('annClue','Ann')" class="mt-2 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">Add Clue</button>
                    </div>
                </div>
                <div class="bg-yellow-50 p-6 rounded-xl border-l-4 border-yellow-500">
                    <h3 class="font-semibold text-lg mb-3">ğŸ§¹ Carlos Diaz, a janitor</h3>
                    <p class="text-gray-700 leading-relaxed">An old man with gray hair was running away, and something fell off his head. It was his wig. I ran after him, but I couldn't catch him. He was faster than me. In fact, the old man was not old. He was a young man with long brown hair.</p>
                    <div class="mt-4 bg-white p-4 rounded-lg border border-yellow-300">
                        <label class="block text-sm font-medium text-yellow-700 mb-2">âœï¸ Write a clue from Carlos's testimony:</label>
                        <input type="text" id="carlosClue" class="w-full p-2 border border-yellow-300 rounded focus:ring-2 focus:ring-yellow-500" placeholder="ì˜ˆ: The suspect wore a gray wig..." />
                        <button onclick="addWitnessClue('carlosClue','Carlos')" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm">Add Clue</button>
                    </div>
                </div>
                <div class="bg-purple-50 p-6 rounded-xl border-l-4 border-purple-500">
                    <h3 class="font-semibold text-lg mb-3">ğŸ›¡ï¸ Diego Perez, a guard</h3>
                    <p class="text-gray-700 leading-relaxed">I went to the crime scene, and there were pieces of cake all over the painting. There was also a wheelchair near the painting, and I found a cake box next to the wheelchair. The box was from Camila's Bakery.</p>
                    <div class="mt-4 bg-white p-4 rounded-lg border border-purple-300">
                        <label class="block text-sm font-medium text-purple-700 mb-2">âœï¸ Write a clue from Diego's testimony:</label>
                        <input type="text" id="diegoClue" class="w-full p-2 border border-purple-300 rounded focus:ring-2 focus:ring-purple-500" placeholder="ì˜ˆ: Found a cake box from Camila's Bakery..." />
                        <button onclick="addWitnessClue('diegoClue','Diego')" class="mt-2 bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">Add Clue</button>
                    </div>
                </div>
                <div class="bg-pink-50 p-6 rounded-xl border-l-4 border-pink-500">
                    <h3 class="font-semibold text-lg mb-3">ğŸ§ Camila Santos, the owner of Camila's Bakery</h3>
                    <p class="text-gray-700 leading-relaxed">Last Friday, a young man came in. I spoke to him in Spanish, but he didn't understand me. He spoke only English. We had a lot of different cakes, but he just wanted the smallest one. We sold only one cake that day, so I remember him clearly. Oh, he had blue eyes.</p>
                    <div class="mt-4 bg-white p-4 rounded-lg border border-pink-300">
                        <label class="block text-sm font-medium text-pink-700 mb-2">âœï¸ Write a clue from Camila's testimony:</label>
                        <input type="text" id="camilaClue" class="w-full p-2 border border-pink-300 rounded focus:ring-2 focus:ring-pink-500" placeholder="ì˜ˆ: The customer had blue eyes and spoke only English..." />
                        <button onclick="addWitnessClue('camilaClue','Camila')" class="mt-2 bg-pink-600 hover:bg-pink-700 text-white px-3 py-1 rounded text-sm">Add Clue</button>
                    </div>
                </div>
            </div>

            <!-- Student Clue Writing Section -->
            <div class="mt-8 bg-gradient-to-r from-indigo-50 to-purple-50 p-6 rounded-xl border-2 border-indigo-200">
                <h3 class="text-xl font-bold text-indigo-800 mb-4">âœï¸ Additional Clues</h3>
                <p class="text-indigo-700 mb-4">Write any other important clues you noticed:</p>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-indigo-700 mb-2">Other important clue:</label>
                        <input type="text" id="studentClue4" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Write any other clue you found..." />
                        <button onclick="addStudentClue('studentClue4')" class="mt-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm">Add to My Clues</button>
                    </div>
                </div>
                <div class="mt-4 p-4 bg-white rounded-lg border border-indigo-200">
                    <h4 class="font-semibold text-indigo-800 mb-2">ğŸ“ All My Written Clues:</h4>
                    <div id="studentCluesList" class="space-y-2">
                        <p class="text-gray-500 italic">Your clues will appear here and in the Clues section...</p>
                    </div>
                </div>
            </div>
            <button onclick="completeSection('story')" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium transition-all">âœ… Mark as Read</button>
        </div>

        <!-- ===== Vocabulary Section ===== -->
        <div id="vocabularySection" class="section bg-white rounded-2xl p-8 shadow-2xl card-hover mb-8 hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">ğŸ“š Vocabulary Learning</h2>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 12 cards provided (you can add 4 more later to make 16) -->
                <!-- bakery -->
                <div class="vocab-card bg-gradient-to-br from-blue-100 to-blue-200 p-6 rounded-xl card-hover cursor-pointer" onclick="flipCard(this)">
                    <div class="front"><h3 class="text-xl font-bold text-blue-800">bakery</h3><p class="text-blue-600 mt-2 text-sm">n.</p><p class="text-blue-500 text-sm mt-1">Click to see meaning</p></div>
                    <div class="back hidden"><h3 class="text-xl font-bold text-blue-800">ë¹µì§‘</h3><p class="text-blue-700 mt-2 text-sm">n.</p><hr class="my-2 border-blue-300" /><p class="text-sm text-blue-700">ì˜ˆë¬¸(ì˜): The bakery is famous for its cheesecakes.</p><p class="text-sm text-blue-600 mt-1">ì˜ˆë¬¸(í•œ): ê·¸ ë¹µì§‘ì€ ì¹˜ì¦ˆì¼€ì´í¬ë¡œ ìœ ëª…í•˜ë‹¤.</p></div>
                </div>
                <!-- crime -->
                <div class="vocab-card bg-gradient-to-br from-green-100 to-green-200 p-6 rounded-xl card-hover cursor-pointer" onclick="flipCard(this)">
                    <div class="front"><h3 class="text-xl font-bold text-green-800">crime</h3><p class="text-green-600 mt-2 text-sm">n.</p><p class="text-green-500 text-sm mt-1">Click to see meaning</p></div>
                    <div class="back hidden"><h3 class="text-xl font-bold text-green-800">ë²”ì£„</h3><p class="text-green-700 mt-2 text-sm">n.</p><hr class="my-2 border-green-300" /><p class="text-sm text-green-700">ì˜ˆë¬¸(ì˜): Writing on walls can be a crime.</p><p class="text-sm text-green-600 mt-1">ì˜ˆë¬¸(í•œ): ë²½ì— ë‚™ì„œí•˜ëŠ” ê²ƒì€ ë²”ì£„ê°€ ë  ìˆ˜ ìˆë‹¤.</p></div>
                </div>
                <!-- criminal -->
                <div class="vocab-card bg-gradient-to-br from-purple-100 to-purple-200 p-6 rounded-xl card-hover cursor-pointer" onclick="flipCard(this)">
                    <div class="front"><h3 class="text-xl font-bold text-purple-800">criminal</h3><p class="text-purple-600 mt-2 text-sm">n.</p><p class="text-purple-500 text-sm mt-1">Click to see meaning</p></div>
                    <div class="back hidden"><h3 class="text-xl font-bold text-purple-800">ë²”ì£„ì</h3><p class="text-purple-700 mt-2 text-sm">n.</p><hr class="my-2 border-purple-300" /><p class="text-sm text-purple-700">ì˜ˆë¬¸(ì˜): The police caught the criminal this morning.</p><p class="text-sm text-purple-600 mt-1">ì˜ˆë¬¸(í•œ): ê²½ì°°ì€ ì˜¤ëŠ˜ ì•„ì¹¨ ê·¸ ë²”ì£„ìë¥¼ ë¶™ì¡ì•˜ë‹¤.</p></div>
                </div>
                <!-- eyewitness -->
                <div class="vocab-card bg-gradient-to-br from-yellow-100 to-yellow-200 p-6 rounded-xl card-hover cursor-pointer" onclick="flipCard(this)">
                    <div class="front"><h3 class="text-xl font-bold text-yellow-800">eyewitness</h3><p class="text-yellow-600 mt-2 text-sm">n.</p><p class="text-yellow-500 text-sm mt-1">Click to see meaning</p></div>
                    <div class="back hidden"><h3 class="text-xl font-bold text-yellow-800">ëª©ê²©ì</h3><p class="text-yellow-700 mt-2 text-sm">n.</p><hr class="my-2 border-yellow-300" /><p class="text-sm text-yellow-700">ì˜ˆë¬¸(ì˜): We are looking for eyewitnesses of the accident.</p><p class="text-sm text-yellow-600 mt-1">ì˜ˆë¬¸(í•œ): ìš°ë¦¬ëŠ” ê·¸ ì‚¬ê³ ì˜ ëª©ê²©ìë¥¼ ì°¾ê³  ìˆë‹¤.</p></div>
                </div>
                <!-- fall off -->
                <div class="vocab-card bg-gradient-to-br from-red-100 to-red-200 p-6 rounded-xl card-hover cursor-pointer" onclick="flipCard(this)">
                    <div class="front"><h3 class="text-xl font-bold text-red-800">fall off</h3><p class="text-red-600 mt-2 text-sm">v.</p><p class="text-red-500 text-sm mt-1">Click to see meaning</p></div>
                    <div class="back hidden"><h3 class="text-xl font-bold text-red-800">ë–¨ì–´ì§€ë‹¤</h3><p class="text-red-700 mt-2 text-sm">v.</p><hr class="my-2 border-red-300" /><p class="text-sm text-red-700">ì˜ˆë¬¸(ì˜): He fell off the stairs and broke his leg.</p><p class="text-sm text-red-600 mt-1">ì˜ˆë¬¸(í•œ): ê·¸ëŠ” ê³„ë‹¨ì—ì„œ ë–¨ì–´ì ¸ ë‹¤ë¦¬ë¥¼ ë‹¤ì³¤ë‹¤.</p></div>
                </div>
                <!-- guard -->
                <div class="vocab-card bg-gradient-to-br from-indigo-100 to-indigo-200 p-6 rounded-xl card-hover cursor-pointer" onclick="flipCard(this)">
                    <div class="front"><h3 class="text-xl font-bold text-indigo-800">guard</h3><p class="text-indigo-600 mt-2 text-sm">n.</p><p class="text-indigo-500 text-sm mt-1">Click to see meaning</p></div>
                    <div class="back hidden"><h3 class="text-xl font-bold text-indigo-800">ê²½ë¹„ì›</h3><p class="text-indigo-700 mt-2 text-sm">n.</p><hr class="my-2 border-indigo-300" /><p class="text-sm text-indigo-700">ì˜ˆë¬¸(ì˜): There are guards at the entrance of the palace.</p><p class="text-sm text-indigo-600 mt-1">ì˜ˆë¬¸(í•œ): ê¶ ì…êµ¬ì—ëŠ” ê²½ë¹„ì›ì´ ìˆë‹¤.</p></div>
                </div>
                <!-- height -->
                <div class="vocab-card bg-gradient-to-br from-pink-100 to-pink-200 p-6 card-hover rounded-xl cursor-pointer" onclick="flipCard(this)">
                    <div class="front"><h3 class="text-xl font-bold text-pink-800">height</h3><p class="text-pink-600 mt-2 text-sm">n.</p><p class="text-pink-500 text-sm mt-1">Click to see meaning</p></div>
                    <div class="back hidden"><h3 class="text-xl font-bold text-pink-800">í‚¤</h3><p class="text-pink-700 mt-2 text-sm">n.</p><hr class="my-2 border-pink-300" /><p class="text-sm text-pink-700">ì˜ˆë¬¸(ì˜): Yuna is the same height as me.</p><p class="text-sm text-pink-600 mt-1">ì˜ˆë¬¸(í•œ): ìœ ë‚˜ëŠ” ë‚˜ì™€ í‚¤ê°€ ê°™ë‹¤.</p></div>
                </div>
                <!-- janitor -->
                <div class="vocab-card bg-gradient-to-br from-teal-100 to-teal-200 p-6 rounded-xl card-hover cursor-pointer" onclick="flipCard(this)">
                    <div class="front"><h3 class="text-xl font-bold text-teal-800">janitor</h3><p class="text-teal-600 mt-2 text-sm">n.</p><p class="text-teal-500 text-sm mt-1">Click to see meaning</p></div>
                    <div class="back hidden"><h3 class="text-xl font-bold text-teal-800">ì²­ì†Œë¶€, ê´€ë¦¬ì¸</h3><p class="text-teal-700 mt-2 text-sm">n.</p><hr class="my-2 border-teal-300" /><p class="text-sm text-teal-700">ì˜ˆë¬¸(ì˜): The school janitor fixed the broken chair for me.</p><p class="text-sm text-teal-600 mt-1">ì˜ˆë¬¸(í•œ): í•™êµ ê´€ë¦¬ì¸ê»˜ì„œ ê³ ì¥ ë‚œ ì˜ìë¥¼ ê³ ì³ ì£¼ì…¨ë‹¤.</p></div>
                </div>
                <!-- language -->
                <div class="vocab-card bg-gradient-to-br from-orange-100 to-orange-200 p-6 rounded-xl card-hover cursor-pointer" onclick="flipCard(this)">
                    <div class="front"><h3 class="text-xl font-bold text-orange-800">language</h3><p class="text-orange-600 mt-2 text-sm">n.</p><p class="text-orange-500 text-sm mt-1">Click to see meaning</p></div>
                    <div class="back hidden"><h3 class="text-xl font-bold text-orange-800">ì–¸ì–´</h3><p class="text-orange-700 mt-2 text-sm">n.</p><hr class="my-2 border-orange-300" /><p class="text-sm text-orange-700">ì˜ˆë¬¸(ì˜): Lily can speak five languages.</p><p class="text-sm text-orange-600 mt-1">ì˜ˆë¬¸(í•œ): ë¦´ë¦¬ëŠ” ë‹¤ì„¯ ê°œ ì–¸ì–´ë¥¼ ë§í•  ìˆ˜ ìˆë‹¤.</p></div>
                </div>
                <!-- owner -->
                <div class="vocab-card bg-gradient-to-br from-cyan-100 to-cyan-200 p-6 rounded-xl card-hover cursor-pointer" onclick="flipCard(this)">
                    <div class="front"><h3 class="text-xl font-bold text-cyan-800">owner</h3><p class="text-cyan-600 mt-2 text-sm">n.</p><p class="text-cyan-500 text-sm mt-1">Click to see meaning</p></div>
                    <div class="back hidden"><h3 class="text-xl font-bold text-cyan-800">ì£¼ì¸</h3><p class="text-cyan-700 mt-2 text-sm">n.</p><hr class="my-2 border-cyan-300" /><p class="text-sm text-cyan-700">ì˜ˆë¬¸(ì˜): Who is the owner of this laptop?</p><p class="text-sm text-cyan-600 mt-1">ì˜ˆë¬¸(í•œ): ì´ ë…¸íŠ¸ë¶ì˜ ì£¼ì¸ì€ ëˆ„êµ¬ì¸ê°€?</p></div>
                </div>
                <!-- piece -->
                <div class="vocab-card bg-gradient-to-br from-lime-100 to-lime-200 p-6 rounded-xl card-hover cursor-pointer" onclick="flipCard(this)">
                    <div class="front"><h3 class="text-xl font-bold text-lime-800">piece</h3><p class="text-lime-600 mt-2 text-sm">n.</p><p class="text-lime-500 text-sm mt-1">Click to see meaning</p></div>
                    <div class="back hidden"><h3 class="text-xl font-bold text-lime-800">ì¡°ê°</h3><p class="text-lime-700 mt-2 text-sm">n.</p><hr class="my-2 border-lime-300" /><p class="text-sm text-lime-700">ì˜ˆë¬¸(ì˜): She cut her finger on a piece of glass.</p><p class="text-sm text-lime-600 mt-1">ì˜ˆë¬¸(í•œ): ê·¸ë…€ëŠ” ìœ ë¦¬ ì¡°ê°ì— ì†ê°€ë½ì„ ë² ì˜€ë‹¤.</p></div>
                </div>
                <!-- run away -->
                <div class="vocab-card bg-gradient-to-br from-violet-100 to-violet-200 p-6 rounded-xl card-hover cursor-pointer" onclick="flipCard(this)">
                    <div class="front"><h3 class="text-xl font-bold text-violet-800">run away</h3><p class="text-violet-600 mt-2 text-sm">v.</p><p class="text-violet-500 text-sm mt-1">Click to see meaning</p></div>
                    <div class="back hidden"><h3 class="text-xl font-bold text-violet-800">ë„ë§ì¹˜ë‹¤</h3><p class="text-violet-700 mt-2 text-sm">v.</p><hr class="my-2 border-violet-300" /><p class="text-sm text-violet-700">ì˜ˆë¬¸(ì˜): My dog often runs away with my sock.</p><p class="text-sm text-violet-600 mt-1">ì˜ˆë¬¸(í•œ): ìš°ë¦¬ ê°•ì•„ì§€ëŠ” ìì£¼ ë‚´ ì–‘ë§ì„ ë¬¼ê³  ë„ë§ê°„ë‹¤.</p></div>
                </div>
                <!-- scene -->
                <div class="vocab-card bg-gradient-to-br from-emerald-100 to-emerald-200 p-6 rounded-xl card-hover cursor-pointer" onclick="flipCard(this)">
                    <div class="front"><h3 class="text-xl font-bold text-emerald-800">scene</h3><p class="text-emerald-600 mt-2 text-sm">n.</p><p class="text-emerald-500 text-sm mt-1">Click to see meaning</p></div>
                    <div class="back hidden"><h3 class="text-xl font-bold text-emerald-800">í˜„ì¥, ì¥ë©´</h3><p class="text-emerald-700 mt-2 text-sm">n.</p><hr class="my-2 border-emerald-300" /><p class="text-sm text-emerald-700">ì˜ˆë¬¸(ì˜): The accident scene was near the bank.</p><p class="text-sm text-emerald-600 mt-1">ì˜ˆë¬¸(í•œ): ì‚¬ê³  í˜„ì¥ì€ ì€í–‰ ê·¼ì²˜ì˜€ë‹¤.</p></div>
                </div>
                <!-- suspect -->
                <div class="vocab-card bg-gradient-to-br from-rose-100 to-rose-200 p-6 rounded-xl card-hover cursor-pointer" onclick="flipCard(this)">
                    <div class="front"><h3 class="text-xl font-bold text-rose-800">suspect</h3><p class="text-rose-600 mt-2 text-sm">n.</p><p class="text-rose-500 text-sm mt-1">Click to see meaning</p></div>
                    <div class="back hidden"><h3 class="text-xl font-bold text-rose-800">ìš©ì˜ì</h3><p class="text-rose-700 mt-2 text-sm">n.</p><hr class="my-2 border-rose-300" /><p class="text-sm text-rose-700">ì˜ˆë¬¸(ì˜): The suspect has brown hair and blue eyes.</p><p class="text-sm text-rose-600 mt-1">ì˜ˆë¬¸(í•œ): ê·¸ ìš©ì˜ìëŠ” ê°ˆìƒ‰ ë¨¸ë¦¬ì— í‘¸ë¥¸ ëˆˆì„ ê°€ì¡Œë‹¤.</p></div>
                </div>
                <!-- wheelchair -->
                <div class="vocab-card bg-gradient-to-br from-sky-100 to-sky-200 p-6 rounded-xl card-hover cursor-pointer" onclick="flipCard(this)">
                    <div class="front"><h3 class="text-xl font-bold text-sky-800">wheelchair</h3><p class="text-sky-600 mt-2 text-sm">n.</p><p class="text-sky-500 text-sm mt-1">Click to see meaning</p></div>
                    <div class="back hidden"><h3 class="text-xl font-bold text-sky-800">íœ ì²´ì–´</h3><p class="text-sky-700 mt-2 text-sm">n.</p><hr class="my-2 border-sky-300" /><p class="text-sm text-sky-700">ì˜ˆë¬¸(ì˜): The building has wide doors for wheelchair users.</p><p class="text-sm text-sky-600 mt-1">ì˜ˆë¬¸(í•œ): ê·¸ ê±´ë¬¼ì€ íœ ì²´ì–´ ì‚¬ìš©ìë¥¼ ìœ„í•œ ë„“ì€ ë¬¸ì´ ìˆë‹¤.</p></div>
                </div>
                <!-- wig -->
                <div class="vocab-card bg-gradient-to-br from-amber-100 to-amber-200 p-6 rounded-xl card-hover cursor-pointer" onclick="flipCard(this)">
                    <div class="front"><h3 class="text-xl font-bold text-amber-800">wig</h3><p class="text-amber-600 mt-2 text-sm">n.</p><p class="text-amber-500 text-sm mt-1">Click to see meaning</p></div>
                    <div class="back hidden"><h3 class="text-xl font-bold text-amber-800">ê°€ë°œ</h3><p class="text-amber-700 mt-2 text-sm">n.</p><hr class="my-2 border-amber-300" /><p class="text-sm text-amber-700">ì˜ˆë¬¸(ì˜): We took a photo with colorful wigs.</p><p class="text-sm text-amber-600 mt-1">ì˜ˆë¬¸(í•œ): ìš°ë¦¬ëŠ” ë‹¤ì–‘í•œ ìƒ‰ê¹”ì˜ ê°€ë°œì„ ì“°ê³  ì‚¬ì§„ì„ ì°ì—ˆë‹¤.</p></div>
                </div>
            </div>
            <button id="completeVocabBtn" onclick="completeSection('vocabulary')" class="mt-6 bg-green-600 text-white px-8 py-3 rounded-lg font-medium transition-all opacity-50 cursor-not-allowed" disabled>âœ… Complete Vocabulary (Flip all 16 cards first)</button>
        </div>

        <!-- ===== Questions Section ===== -->
        <div id="questionsSection" class="section bg-white rounded-2xl p-8 shadow-2xl card-hover mb-8 hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">â“ Reading Comprehension</h2>
            <div class="space-y-6">
                <div class="question-item bg-blue-50 p-6 rounded-xl"><h3 class="font-semibold text-lg mb-3">1. How tall was the old man?</h3><textarea id="answer1" class="w-full p-3 border rounded-lg" rows="3" placeholder="Write your answer here..."></textarea><button onclick="saveAnswer(1)" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Save Answer</button></div>
                <div class="question-item bg-green-50 p-6 rounded-xl"><h3 class="font-semibold text-lg mb-3">2. What fell off the old man's head?</h3><textarea id="answer2" class="w-full p-3 border rounded-lg" rows="3" placeholder="Write your answer here..."></textarea><button onclick="saveAnswer(2)" class="mt-3 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Save Answer</button></div>
                <div class="question-item bg-yellow-50 p-6 rounded-xl"><h3 class="font-semibold text-lg mb-3">3. What did Diego find next to the wheelchair?</h3><textarea id="answer3" class="w-full p-3 border rounded-lg" rows="3" placeholder="Write your answer here..."></textarea><button onclick="saveAnswer(3)" class="mt-3 bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded">Save Answer</button></div>
                <div class="question-item bg-purple-50 p-6 rounded-xl"><h3 class="font-semibold text-lg mb-3">4. Why does Camila remember the old man clearly?</h3><textarea id="answer4" class="w-full p-3 border rounded-lg" rows="3" placeholder="Write your answer here..."></textarea><button onclick="saveAnswer(4)" class="mt-3 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">Save Answer</button></div>
            </div>
            <button id="completeQuestionsBtn" onclick="completeSection('questions')" class="mt-6 bg-orange-600 hover:bg-orange-700 text-white px-8 py-3 rounded-lg font-medium transition-all opacity-50 cursor-not-allowed" disabled>âœ… Complete Questions (Answer all 4 questions first)</button>
            <div id="sharedAnswersSection" class="mt-8 bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-xl border-2 border-blue-200 hidden">
                <h3 class="text-xl font-bold text-blue-800 mb-4">ğŸ‘¥ Class Answers Board</h3>
                <p class="text-blue-700 mb-4">See what your classmates wrote:</p>
                <div id="classAnswersDisplay" class="space-y-4"></div>
                <div class="mt-4 text-center"><button onclick="shareMyAnswers()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium">ğŸ“¤ Share My Answers with Class</button></div>
            </div>
        </div>

        <!-- ===== Grammar Section ===== -->
        <div id="grammarSection" class="section bg-white rounded-2xl p-8 shadow-2xl card-hover mb-8 hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">ğŸ“ Grammar Practice</h2>
            <div class="space-y-8">
                <div class="grammar-explanation bg-blue-50 p-6 rounded-xl border-l-4 border-blue-500">
                    <h3 class="text-xl font-semibold mb-4 text-blue-800">ğŸ“š There is / There are</h3>
                    <div class="space-y-3 text-blue-700">
                        <p><strong>There is</strong> + ë‹¨ìˆ˜ ëª…ì‚¬ (one thing)</p>
                        <p class="ml-4">ì˜ˆ: There <strong>is</strong> a wheelchair near the painting.</p>
                        <p><strong>There are</strong> + ë³µìˆ˜ ëª…ì‚¬ (two or more things)</p>
                        <p class="ml-4">ì˜ˆ: There <strong>are</strong> pieces of cake on the floor.</p>
                    </div>
                </div>
                <div class="grammar-exercise">
                    <h3 class="text-xl font-semibold mb-4">There is / There are Practice</h3>
                    <div class="question bg-gray-50 p-4 rounded-lg mb-4">
                        <p class="mb-4">1. _____ four eyewitnesses in the museum.</p>
                        <div class="space-y-2">
                            <label class="flex items-center cursor-pointer"><input type="radio" name="q1" value="There is" class="mr-3" /><span>There is</span></label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="q1" value="There are" class="mr-3" /><span>There are</span></label>
                        </div>
                        <button onclick="checkGrammar('q1','There are')" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Check Answer</button>
                        <div id="q1-feedback" class="mt-2 hidden"></div>
                    </div>
                    <div class="question bg-gray-50 p-4 rounded-lg mb-4">
                        <p class="mb-4">2. _____ a cake box next to the wheelchair.</p>
                        <div class="space-y-2">
                            <label class="flex items-center cursor-pointer"><input type="radio" name="q2" value="There is" class="mr-3" /><span>There is</span></label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="q2" value="There are" class="mr-3" /><span>There are</span></label>
                        </div>
                        <button onclick="checkGrammar('q2','There is')" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Check Answer</button>
                        <div id="q2-feedback" class="mt-2 hidden"></div>
                    </div>
                    <div class="question bg-gray-50 p-4 rounded-lg mb-4">
                        <p class="mb-4">3. _____ many different cakes in the bakery.</p>
                        <div class="space-y-2">
                            <label class="flex items-center cursor-pointer"><input type="radio" name="q3" value="There is" class="mr-3" /><span>There is</span></label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="q3" value="There are" class="mr-3" /><span>There are</span></label>
                        </div>
                        <button onclick="checkGrammar('q3','There are')" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Check Answer</button>
                        <div id="q3-feedback" class="mt-2 hidden"></div>
                    </div>
                </div>
                <!-- Comparative explanation -->
                <div class="grammar-explanation bg-green-50 p-6 rounded-xl border-l-4 border-green-500">
                    <h3 class="text-xl font-semibold mb-4 text-green-800">ğŸ“š Comparative (ë¹„êµê¸‰)</h3>
                    <div class="space-y-3 text-green-700">
                        <p><strong>ì§§ì€ í˜•ìš©ì‚¬</strong>: í˜•ìš©ì‚¬ + er + than</p>
                        <p class="ml-4">ì˜ˆ: tall â†’ tall<strong>er</strong> than, fast â†’ fast<strong>er</strong> than</p>
                        <p><strong>ê¸´ í˜•ìš©ì‚¬</strong>: more + í˜•ìš©ì‚¬ + than</p>
                        <p class="ml-4">ì˜ˆ: beautiful â†’ <strong>more</strong> beautiful than</p>
                    </div>
                </div>
                <div class="grammar-exercise">
                    <h3 class="text-xl font-semibold mb-4">Comparative Practice</h3>
                    <div class="question bg-gray-50 p-4 rounded-lg mb-4">
                        <p class="mb-4">4. He was _____ than me. (fast)</p>
                        <div class="space-y-2">
                            <label class="flex items-center cursor-pointer"><input type="radio" name="q4" value="fast" class="mr-3" /><span>fast</span></label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="q4" value="faster" class="mr-3" /><span>faster</span></label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="q4" value="more fast" class="mr-3" /><span>more fast</span></label>
                        </div>
                        <button onclick="checkGrammar('q4','faster')" class="mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Check Answer</button>
                        <div id="q4-feedback" class="mt-2 hidden"></div>
                    </div>
                    <div class="question bg-gray-50 p-4 rounded-lg mb-4">
                        <p class="mb-4">5. Ann is _____ than the suspect. (short)</p>
                        <div class="space-y-2">
                            <label class="flex items-center cursor-pointer"><input type="radio" name="q5" value="short" class="mr-3" /><span>short</span></label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="q5" value="shorter" class="mr-3" /><span>shorter</span></label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="q5" value="more short" class="mr-3" /><span>more short</span></label>
                        </div>
                        <button onclick="checkGrammar('q5','shorter')" class="mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Check Answer</button>
                        <div id="q5-feedback" class="mt-2 hidden"></div>
                    </div>
                    <div class="question bg-gray-50 p-4 rounded-lg mb-4">
                        <p class="mb-4">6. The Monalisa is _____ than other paintings. (famous)</p>
                        <div class="space-y-2">
                            <label class="flex items-center cursor-pointer"><input type="radio" name="q6" value="famous" class="mr-3" /><span>famous</span></label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="q6" value="famouser" class="mr-3" /><span>famouser</span></label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="q6" value="more famous" class="mr-3" /><span>more famous</span></label>
                        </div>
                        <button onclick="checkGrammar('q6','more famous')" class="mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Check Answer</button>
                        <div id="q6-feedback" class="mt-2 hidden"></div>
                    </div>
                </div>
            </div>
            <button id="completeGrammarBtn" onclick="completeSection('grammar')" class="mt-6 bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 rounded-lg font-medium transition-all opacity-50 cursor-not-allowed" disabled>âœ… Complete Grammar (Answer all 6 questions first)</button>
        </div>

        <!-- ===== Clues Section ===== -->
        <div id="cluesSection" class="section bg-white rounded-2xl p-8 shadow-2xl card-hover mb-8 hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">ğŸ” Clue Collection Board</h2>
            <div class="max-w-2xl mx-auto">
                <h3 class="text-xl font-semibold mb-4 text-center">ğŸ“ My Written Clues</h3>
                <div id="studentCluesDisplay" class="bg-indigo-50 p-6 rounded-lg min-h-64"><p class="text-indigo-500 italic text-center">Your written clues from the story will appear here...</p></div>
                <div class="text-center mt-6"><button onclick="clearClues()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg">Clear All Clues</button></div>
            </div>
            <button onclick="completeSection('clues')" class="mt-6 bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-lg font-medium transition-all">âœ… Complete Clue Collection</button>
        </div>

        <!-- ===== Sketch Section ===== -->
        <div id="sketchSection" class="section bg-white rounded-2xl p-8 shadow-2xl card-hover mb-8 hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">ğŸ¨ Draw the Suspect</h2>
            <div class="grid lg:grid-cols-4 gap-6">
                <div class="lg:col-span-3">
                    <div class="canvas-container"><canvas id="drawingCanvas" width="600" height="400" class="w-full"></canvas></div>
                    <div class="flex justify-center gap-4 mt-4">
                        <button onclick="clearCanvas()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Clear</button>
                        <button onclick="saveSketch()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Save Sketch</button>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-4">Color Palette</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="color-btn active" style="background:#000000" onclick="selectColor('#000000')"></div>
                        <div class="color-btn" style="background:#8B4513" onclick="selectColor('#8B4513')"></div>
                        <div class="color-btn" style="background:#FFE4B5" onclick="selectColor('#FFE4B5')"></div>
                        <div class="color-btn" style="background:#0000FF" onclick="selectColor('#0000FF')"></div>
                        <div class="color-btn" style="background:#808080" onclick="selectColor('#808080')"></div>
                        <div class="color-btn" style="background:#FF0000" onclick="selectColor('#FF0000')"></div>
                    </div>
                    <h3 class="text-lg font-semibold mb-4 mt-6">Brush Size</h3>
                    <input type="range" id="brushSize" min="1" max="20" value="5" class="w-full" />
                    <p class="text-center mt-2">Size: <span id="brushSizeValue">5</span>px</p>
                </div>
            </div>
            <button onclick="completeSection('sketch')" class="mt-6 bg-pink-600 hover:bg-pink-700 text-white px-8 py-3 rounded-lg font-medium transition-all">âœ… Complete Sketch</button>
            <div id="sharedSketchesSection" class="mt-8 bg-gradient-to-r from-pink-50 to-purple-50 p-6 rounded-xl border-2 border-pink-200">
                <h3 class="text-xl font-bold text-pink-800 mb-4">ğŸ¨ Class Sketch Gallery</h3>
                <p class="text-pink-700 mb-4">See how your classmates drew the suspect:</p>
                <div id="classSketchesDisplay" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4"><div class="text-center text-pink-500 italic">Shared sketches will appear here...</div></div>
                <div class="text-center"><button onclick="shareMySketch()" class="bg-pink-600 hover:bg-pink-700 text-white px-6 py-3 rounded-lg font-medium">ğŸ–¼ï¸ Share My Sketch with Class</button></div>
            </div>
        </div>

        <!-- ===== Solve Section ===== -->
        <div id="solveSection" class="section bg-white rounded-2xl p-8 shadow-2xl card-hover mb-8 hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">ğŸ•µï¸ Solve the Mystery</h2>
            <p class="text-lg mb-6">Now look at the information about the suspects. Who threw the cake at the Monalisa?</p>
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="suspect-card border-2 border-gray-200 p-6 rounded-xl text-center" onclick="selectSuspect(this,'Andres Lozano')"><div class="text-6xl mb-4">ğŸ‘¨â€ğŸ’¼</div><h3 class="font-bold text-lg">Andres Lozano</h3><div class="text-sm text-gray-600 mt-2 space-y-1"><p>Height: 176 cm</p><p>Hair: long, black</p><p>Languages: Spanish, English</p><p>Eyes: brown</p></div></div>
                <div class="suspect-card border-2 border-gray-200 p-6 rounded-xl text-center" onclick="selectSuspect(this,'Larry Johnson')"><div class="text-6xl mb-4">ğŸ‘¨â€ğŸ¨</div><h3 class="font-bold text-lg">Larry Johnson</h3><div class="text-sm text-gray-600 mt-2 space-y-1"><p>Height: 173 cm</p><p>Hair: long, brown</p><p>Languages: English</p><p>Eyes: blue</p></div></div>
                <div class="suspect-card border-2 border-gray-200 p-6 rounded-xl text-center" onclick="selectSuspect(this,'Tim Baker')"><div class="text-6xl mb-4">ğŸ‘¨â€ğŸ³</div><h3 class="font-bold text-lg">Tim Baker</h3><div class="text-sm text-gray-600 mt-2 space-y-1"><p>Height: 182 cm</p><p>Hair: long, brown</p><p>Languages: English</p><p>Eyes: green</p></div></div>
                <div class="suspect-card border-2 border-gray-200 p-6 rounded-xl text-center" onclick="selectSuspect(this,'Luca Ferez')"><div class="text-6xl mb-4">ğŸ‘¨â€ğŸ¦³</div><h3 class="font-bold text-lg">Luca Ferez</h3><div class="text-sm text-gray-600 mt-2 space-y-1"><p>Height: 166 cm</p><p>Hair: short, gray</p><p>Languages: Spanish</p><p>Eyes: blue</p></div></div>
            </div>
            <div class="bg-yellow-50 p-6 rounded-xl mb-6"><h3 class="font-semibold text-lg mb-3">Your Reasoning:</h3><textarea id="reasoning" class="w-full p-4 border rounded-lg" rows="4" placeholder="Explain why you chose this suspect based on the evidence..." oninput="checkMysteryCompletion()"></textarea></div>
            <button id="completeMysteryBtn" onclick="completeMystery()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-lg font-bold text-lg transition-all opacity-50 cursor-not-allowed" disabled>âœ… Complete Mystery (Select suspect & write reasoning first)</button>
            <button id="revealBtn" onclick="revealTruth()" class="hidden bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white px-8 py-4 rounded-lg font-bold text-lg transition-all mt-4">ğŸ¯ Reveal the Truth!</button>
            <div id="solution" class="hidden mt-6 p-6 bg-green-50 border-2 border-green-200 rounded-xl"><h3 class="text-2xl font-bold text-green-800 mb-4">ğŸ‰ Mystery Solved!</h3><p class="text-green-700 text-lg">The correct answer is <strong>Larry Johnson</strong>!</p><p class="text-green-600 mt-4">Based on the clues: young man with long brown hair, blue eyes, spoke only English, wore a gray wig as disguise, and bought a cake from Camila's Bakery. Larry Johnson matches all these characteristics perfectly!</p></div>
            <!-- Class Solutions Section -->
            <div id="classSolutionsSection" class="hidden mt-8 bg-gradient-to-r from-purple-50 to-indigo-50 p-6 rounded-xl border-2 border-purple-200">
                <h3 class="text-xl font-bold text-purple-800 mb-4">ğŸ•µï¸ Class Detective Board</h3>
                <p class="text-purple-700 mb-4">See what suspects your classmates chose and their reasoning:</p>
                <div id="classSolutionsDisplay" class="space-y-4 mb-4"><div class="text-center text-purple-500 italic">Complete your mystery solution to see classmates' answers...</div></div>
                <div class="text-center"><button id="shareSolutionBtn" onclick="shareMySolution()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium hidden">ğŸ” Share My Solution with Class</button></div>
            </div>
        </div>
    </div>

    <!-- ===== Core Logic & Realtime ===== -->
    <script>
    // Game state
    let gameState = {
        completedSections: new Set(), collectedClues: [], studentClues: [], selectedSuspect: null, answers: {},
        currentColor: '#000000', brushSize: 5, isDrawing: false, flippedCards: new Set(), grammarAnswers: new Set(),
        sharedAnswers: [], sharedSketches: [], sharedSolutions: [], hasSharedAnswers: false, hasSharedSketch: false,
        hasSharedSolution: false, firebaseConnected: false, roomId: null
    };

    // Firebase connection and room management
    let firebaseInitialized = false;
    function initializeFirebase(){
        if (!window.firebaseDB){ setTimeout(initializeFirebase, 120); return; }
        try{
            // Use ?room=â€¦ from URL if present, else localStorage, else public
            const params = new URLSearchParams(location.search);
            const urlRoom = params.get('room');
            gameState.roomId = urlRoom || localStorage.getItem('mysteryGameRoom') || 'public';
            localStorage.setItem('mysteryGameRoom', gameState.roomId);

            // Reflect auth status
            gameState.firebaseConnected = !!window.firebaseUser;
            updateFirebaseStatus();
            setupFirebaseListeners();
            firebaseInitialized = true;
            console.log('Firebase initialized successfully with room:', gameState.roomId);
        }catch(err){ console.error('Firebase initialization error:', err); updateFirebaseStatus(false); }
    }
        try{
            gameState.roomId = localStorage.getItem('mysteryGameRoom') || generateRoomId();
            localStorage.setItem('mysteryGameRoom', gameState.roomId);
            gameState.firebaseConnected = true; updateFirebaseStatus(); setupFirebaseListeners(); firebaseInitialized = true;
            console.log('Firebase initialized successfully with room:', gameState.roomId);
        }catch(err){ console.error('Firebase initialization error:', err); updateFirebaseStatus(false); }
    
    function generateRoomId(){ return 'room_' + Math.random().toString(36).slice(2,11); }
    function updateFirebaseStatus(connected = gameState.firebaseConnected){ const el = document.getElementById('firebaseStatus'); if(!el) return; if(connected){ el.textContent = `ğŸŸ¢ Connected (Room: ${gameState.roomId})`; el.className = 'firebase-status firebase-connected'; } else { el.textContent = 'ğŸ”´ Connection Failed'; el.className = 'firebase-status firebase-disconnected'; } }
    function setupFirebaseListeners(){ if(!gameState.firebaseConnected) return; const answersRef = window.firebaseRef(window.firebaseDB, `rooms/${gameState.roomId}/answers`); window.firebaseOnValue(answersRef,(snap)=>{ const data=snap.val(); if(data){ gameState.sharedAnswers = Object.values(data).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)); displaySharedAnswers(); }}); const sketchesRef = window.firebaseRef(window.firebaseDB, `rooms/${gameState.roomId}/sketches`); window.firebaseOnValue(sketchesRef,(snap)=>{ const data=snap.val(); if(data){ gameState.sharedSketches = Object.values(data).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)); displaySharedSketches(); }}); const solutionsRef = window.firebaseRef(window.firebaseDB, `rooms/${gameState.roomId}/solutions`); window.firebaseOnValue(solutionsRef,(snap)=>{ const data=snap.val(); if(data){ gameState.sharedSolutions = Object.values(data).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)); displaySharedSolutions(); }}); }

    // Initialize canvas & Firebase on load
    let canvas, ctx;
    window.onload = function(){
        canvas = document.getElementById('drawingCanvas');
        if (canvas){ ctx = canvas.getContext('2d'); ctx.lineCap='round'; ctx.lineJoin='round'; canvas.addEventListener('mousedown', startDrawing); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', stopDrawing); canvas.addEventListener('mouseout', stopDrawing); canvas.addEventListener('touchstart', handleTouch,{passive:false}); canvas.addEventListener('touchmove', handleTouch,{passive:false}); canvas.addEventListener('touchend', stopDrawing); const slider=document.getElementById('brushSize'); const sizeVal=document.getElementById('brushSizeValue'); if(slider&&sizeVal){ slider.addEventListener('input', function(){ gameState.brushSize=this.value; sizeVal.textContent=this.value; }); } }
        showSection('story'); initializeFirebase();
    };

    // Navigation & progress
    function showSection(sectionName){ document.querySelectorAll('.section').forEach(s=>s.classList.add('hidden')); const el=document.getElementById(sectionName+'Section'); if(el){ el.classList.remove('hidden'); el.classList.add('fade-in'); } if (typeof event!=='undefined' && event.target){ document.querySelectorAll('.nav-btn').forEach(btn=>{ btn.classList.remove('bg-white','text-gray-800'); btn.classList.add('bg-white/20','text-white'); }); event.target.classList.remove('bg-white/20','text-white'); event.target.classList.add('bg-white','text-gray-800'); } }
    function completeSection(sectionName){ gameState.completedSections.add(sectionName); updateProgress(); const btn=event?.target; const text=btn?.textContent; if(btn){ btn.textContent='âœ… Completed!'; btn.classList.add('bg-green-600'); setTimeout(()=>{ btn.textContent=text; btn.classList.remove('bg-green-600'); }, 1500); }}
    function updateProgress(){ const total=6; const done=gameState.completedSections.size; const pct=(done/total)*100; document.getElementById('progressBar').style.width=pct+'%'; document.getElementById('progressText').textContent=`${done}/${total}`; }

    // Vocabulary
    function flipCard(card){ const front=card.querySelector('.front'); const back=card.querySelector('.back'); const word=front.querySelector('h3').textContent; if(front.classList.contains('hidden')){ front.classList.remove('hidden'); back.classList.add('hidden'); } else { front.classList.add('hidden'); back.classList.remove('hidden'); gameState.flippedCards.add(word); checkVocabularyCompletion(); } }
    function checkVocabularyCompletion(){ const total=16; const btn=document.getElementById('completeVocabBtn'); if(!btn) return; if(gameState.flippedCards.size>=total){ btn.disabled=false; btn.classList.remove('opacity-50','cursor-not-allowed'); btn.textContent='âœ… Complete Vocabulary'; } else { btn.textContent=`âœ… Complete Vocabulary (Flip all 16 cards first - ${gameState.flippedCards.size}/16)`; } }

    // Grammar
    function checkGrammar(questionId, correctAnswer){ const selected=document.querySelector(`input[name="${questionId}"]:checked`); const feedback=document.getElementById(`${questionId}-feedback`); if(!selected){ feedback.innerHTML='<p class="text-red-600">Please select an answer!</p>'; feedback.classList.remove('hidden'); return; } if(selected.value===correctAnswer){ feedback.innerHTML='<p class="text-green-600">âœ… Correct! Well done!</p>'; gameState.grammarAnswers.add(questionId); } else { feedback.innerHTML=`<p class="text-red-600">âŒ Incorrect. The correct answer is "${correctAnswer}".</p>`; } feedback.classList.remove('hidden'); checkGrammarCompletion(); }
    function checkGrammarCompletion(){ const totalQuestions=6; const completeBtn=document.getElementById('completeGrammarBtn'); if(gameState.grammarAnswers.size>=totalQuestions){ completeBtn.disabled=false; completeBtn.classList.remove('opacity-50','cursor-not-allowed'); completeBtn.textContent='âœ… Complete Grammar'; } else { completeBtn.textContent=`âœ… Complete Grammar (Answer all 6 questions first - ${gameState.grammarAnswers.size}/6)`; } }

    // Questions
    function saveAnswer(questionNum){ const answer=document.getElementById(`answer${questionNum}`).value.trim(); if(answer===''){ alert('Please write an answer first!'); return; } gameState.answers[questionNum]=answer; const button=event.target; const originalText=button.textContent; button.textContent='âœ… Saved!'; button.classList.add('bg-green-600'); setTimeout(()=>{ button.textContent=originalText; button.classList.remove('bg-green-600'); }, 1200); checkQuestionsCompletion(); }
    function checkQuestionsCompletion(){ const totalQuestions=4; const completeBtn=document.getElementById('completeQuestionsBtn'); const answeredCount=Object.keys(gameState.answers).filter(key=> gameState.answers[key] && gameState.answers[key].trim()!=='').length; if(answeredCount>=totalQuestions){ completeBtn.disabled=false; completeBtn.classList.remove('opacity-50','cursor-not-allowed'); completeBtn.textContent='âœ… Complete Questions'; document.getElementById('sharedAnswersSection').classList.remove('hidden'); } else { completeBtn.textContent=`âœ… Complete Questions (Answer all 4 questions first - ${answeredCount}/4)`; } }

    // Share Answers (Realtime)
    function shareMyAnswers(){
        if(gameState.hasSharedAnswers){ alert('You have already shared your answers!'); return; }
        if (!window.firebaseUser) { alert('Connecting to Firebaseâ€¦ please try again in a moment.'); return; }
        const studentName=prompt('Enter your name to share your answers:');
        if(!studentName||studentName.trim()==='') return;
        localStorage.setItem('userName', studentName.trim());
        const myAnswers={ uid: window.firebaseUser.uid, name: studentName.trim(), answers:{...gameState.answers}, timestamp:new Date().toISOString(), displayTime:new Date().toLocaleTimeString() };
        if(gameState.firebaseConnected){
            const answersRef=window.firebaseRef(window.firebaseDB, `rooms/${gameState.roomId}/answers`);
            const dup = (gameState.sharedAnswers||[]).some(a => a.uid === myAnswers.uid);
            if (dup) { alert('You already shared your answers!'); return; }
            window.firebasePush(answersRef, myAnswers);
        } else {
            gameState.sharedAnswers.unshift(myAnswers); displaySharedAnswers();
        }
        gameState.hasSharedAnswers=true;
        const button=event.target; button.textContent='âœ… Shared with Class!'; button.disabled=true; button.classList.add('opacity-50');
    } const studentName=prompt('Enter your name to share your answers:'); if(!studentName||studentName.trim()==='') return; localStorage.setItem('userName', studentName.trim()); const myAnswers={ name: studentName.trim(), answers:{...gameState.answers}, timestamp:new Date().toISOString(), displayTime:new Date().toLocaleTimeString() }; if(gameState.firebaseConnected){ const answersRef=window.firebaseRef(window.firebaseDB, `rooms/${gameState.roomId}/answers`); window.firebasePush(answersRef, myAnswers); } else { gameState.sharedAnswers.unshift(myAnswers); displaySharedAnswers(); } gameState.hasSharedAnswers=true; const button=event.target; button.textContent='âœ… Shared with Class!'; button.disabled=true; button.classList.add('opacity-50'); 
    function displaySharedAnswers(){ const display=document.getElementById('classAnswersDisplay'); const questions=['How tall was the old man?',"What fell off the old man's head?",'What did Diego find next to the wheelchair?','Why does Camila remember the old man clearly?']; if(gameState.sharedAnswers.length===0){ display.innerHTML='<p class="text-blue-500 italic">No answers shared yet... Be the first to share!</p>'; return; } display.innerHTML=gameState.sharedAnswers.map((student,index)=>{ const isUserAnswer=student.name===localStorage.getItem('userName'); return `<div class="bg-white p-4 rounded-lg border-2 ${isUserAnswer?'border-green-400 bg-green-50':'border-blue-200'} mb-3 ${index===0?'new-share-notification':''}"><h4 class="font-semibold ${isUserAnswer?'text-green-800':'text-blue-800'} mb-3">ğŸ‘¤ ${student.name} ${isUserAnswer?'(Your Answers)':''} (${student.displayTime})</h4><div class="space-y-2">${questions.map((q,i)=>`<div class='text-sm bg-gray-50 p-2 rounded'><span class='font-medium text-gray-700'>Q${i+1}: ${q}</span><br><span class='text-gray-800 ml-2'>ğŸ’¬ ${student.answers[i+1]||'No answer'}</span></div>`).join('')}</div></div>`; }).join(''); }

    // Clues
    function clearClues(){ gameState.collectedClues=[]; gameState.studentClues=[]; updateStudentCluesDisplay(); updateStudentCluesList(); }
    function addStudentClue(inputId){ const input=document.getElementById(inputId); const clueText=input.value.trim(); if(clueText===''){ alert('Please write a clue first!'); return; } if(!gameState.studentClues.includes(clueText)){ gameState.studentClues.push(clueText); updateStudentCluesList(); updateStudentCluesDisplay(); input.value=''; const button=event.target; const originalText=button.textContent; button.textContent='âœ… Added!'; setTimeout(()=>{ button.textContent=originalText; }, 1200); } else { alert('This clue has already been added!'); } }
    function addWitnessClue(inputId, witnessName){ const input=document.getElementById(inputId); const clueText=input.value.trim(); if(clueText===''){ alert('Please write a clue first!'); return; } const formattedClue=`${witnessName}: ${clueText}`; if(!gameState.studentClues.includes(formattedClue)){ gameState.studentClues.push(formattedClue); updateStudentCluesList(); updateStudentCluesDisplay(); input.value=''; const button=event.target; const originalText=button.textContent; button.textContent='âœ… Added!'; setTimeout(()=>{ button.textContent=originalText; }, 1200); } else { alert('This clue has already been added!'); } }
    function updateStudentCluesList(){ const list=document.getElementById('studentCluesList'); if(gameState.studentClues.length===0){ list.innerHTML='<p class="text-gray-500 italic">Your clues will appear here and in the Clues section...</p>'; } else { list.innerHTML=gameState.studentClues.map((clue,index)=>`<div class="bg-indigo-100 p-3 rounded-lg border-l-4 border-indigo-500"><span class="text-indigo-800">${clue}</span><button onclick="removeStudentClue(${index})" class="ml-2 text-red-600 hover:text-red-800 text-sm">âœ•</button></div>`).join(''); } }
    function updateStudentCluesDisplay(){ const display=document.getElementById('studentCluesDisplay'); if(gameState.studentClues.length===0){ display.innerHTML='<p class="text-indigo-500 italic">Your written clues from the story will appear here...</p>'; } else { display.innerHTML=gameState.studentClues.map(clue=>`<div class="bg-white p-3 rounded-lg mb-2 border-l-4 border-indigo-500"><span class="text-indigo-800">ğŸ“ ${clue}</span></div>`).join(''); } }
    function removeStudentClue(index){ gameState.studentClues.splice(index,1); updateStudentCluesList(); updateStudentCluesDisplay(); }

    // Drawing
    function selectColor(color){ gameState.currentColor=color; document.querySelectorAll('.color-btn').forEach(btn=>btn.classList.remove('active')); if(event?.target?.classList) event.target.classList.add('active'); }
    function startDrawing(e){ gameState.isDrawing=true; const rect=canvas.getBoundingClientRect(); const x=e.clientX-rect.left; const y=e.clientY-rect.top; ctx.beginPath(); ctx.moveTo(x,y); }
    function draw(e){ if(!gameState.isDrawing) return; const rect=canvas.getBoundingClientRect(); const x=e.clientX-rect.left; const y=e.clientY-rect.top; ctx.lineWidth=gameState.brushSize; ctx.strokeStyle=gameState.currentColor; ctx.lineTo(x,y); ctx.stroke(); }
    function stopDrawing(){ gameState.isDrawing=false; }
    function handleTouch(e){ e.preventDefault(); const touch=e.touches[0]; const mouseEvent=new MouseEvent(e.type==='touchstart'?'mousedown': e.type==='touchmove'?'mousemove':'mouseup',{ clientX:touch.clientX, clientY:touch.clientY}); canvas.dispatchEvent(mouseEvent); }
    function clearCanvas(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
    function saveSketch(){ const button=event.target; const originalText=button.textContent; button.textContent='âœ… Saved!'; button.classList.add('bg-green-600'); setTimeout(()=>{ button.textContent=originalText; button.classList.remove('bg-green-600'); }, 1200); }

    // Share sketches
    function shareMySketch(){ if(gameState.hasSharedSketch){ alert('You have already shared your sketch!'); return; } const studentName=prompt('Enter your name to share your sketch:'); if(!studentName||studentName.trim()==='') return; localStorage.setItem('userName', studentName.trim()); const sketchData=canvas.toDataURL(); const mySketch={ uid: window.firebaseUser?.uid, name:studentName.trim(), sketch:sketchData, timestamp:new Date().toISOString(), displayTime:new Date().toLocaleTimeString() }; if(gameState.firebaseConnected){ const sketchesRef=window.firebaseRef(window.firebaseDB, `rooms/${gameState.roomId}/sketches`); window.firebasePush(sketchesRef, mySketch); } else { gameState.sharedSketches.unshift(mySketch); displaySharedSketches(); } gameState.hasSharedSketch=true; const button=event.target; const originalText=button.textContent; button.textContent='âœ… Shared with Class!'; button.disabled=true; button.classList.add('opacity-50'); }
    function displaySharedSketches(){ const display=document.getElementById('classSketchesDisplay'); if(gameState.sharedSketches.length===0){ display.innerHTML='<div class="text-center text-pink-500 italic">No sketches shared yet... Be the first to share!</div>'; return; } display.innerHTML=gameState.sharedSketches.map((student,index)=>{ const isUserSketch=student.name===localStorage.getItem('userName'); return `<div class="bg-white p-4 rounded-lg border-2 ${isUserSketch?'border-green-400 bg-green-50':'border-pink-200'} text-center ${index===0?'new-share-notification':''}"><h4 class="font-semibold ${isUserSketch?'text-green-800':'text-pink-800'} mb-2">ğŸ‘¤ ${student.name} ${isUserSketch?'(Your Sketch)':''}</h4><div class="bg-gray-100 p-2 rounded mb-2 border-2 border-gray-300"><img src='${student.sketch}' alt='${student.name}\'s sketch' class='w-full h-32 object-contain rounded'></div><p class="text-sm ${isUserSketch?'text-green-600':'text-pink-600'}">${student.displayTime}</p></div>`; }).join(''); }

    // Solve
    function selectSuspect(card, suspectName){ document.querySelectorAll('.suspect-card').forEach(c=>c.classList.remove('selected')); card.classList.add('selected'); gameState.selectedSuspect=suspectName; checkMysteryCompletion(); }
    function checkMysteryCompletion(){ const reasoning=document.getElementById('reasoning').value.trim(); const completeMysteryBtn=document.getElementById('completeMysteryBtn'); if(gameState.selectedSuspect && reasoning.length>0){ completeMysteryBtn.disabled=false; completeMysteryBtn.classList.remove('opacity-50','cursor-not-allowed'); completeMysteryBtn.textContent='âœ… Complete Mystery'; } else { completeMysteryBtn.disabled=true; completeMysteryBtn.classList.add('opacity-50','cursor-not-allowed'); completeMysteryBtn.textContent='âœ… Complete Mystery (Select suspect & write reasoning first)'; } }
    function completeMystery(){ if(!gameState.selectedSuspect || !document.getElementById('reasoning').value.trim()){ alert('Please select a suspect and write your reasoning first!'); return; } completeSection('solve'); document.getElementById('revealBtn').classList.remove('hidden'); document.getElementById('classSolutionsSection').classList.remove('hidden'); document.getElementById('shareSolutionBtn').classList.remove('hidden'); document.getElementById('completeMysteryBtn').style.display='none'; }
    function revealTruth(){ document.getElementById('solution').classList.remove('hidden'); document.getElementById('solution').scrollIntoView({behavior:'smooth'}); document.getElementById('revealBtn').style.display='none'; }

    // Share Solutions & grouped view
    function shareMySolution(){ if(gameState.hasSharedSolution){ alert('You have already shared your solution!'); return; } const studentName=prompt('Enter your name to share your solution:'); if(!studentName||studentName.trim()==='') return; localStorage.setItem('userName', studentName.trim()); const mySolution={ uid: window.firebaseUser?.uid, name:studentName.trim(), suspect:gameState.selectedSuspect, reasoning:document.getElementById('reasoning').value.trim(), timestamp:new Date().toISOString(), displayTime:new Date().toLocaleTimeString() }; if(gameState.firebaseConnected){ const solutionsRef=window.firebaseRef(window.firebaseDB, `rooms/${gameState.roomId}/solutions`); window.firebasePush(solutionsRef, mySolution); } else { gameState.sharedSolutions.unshift(mySolution); displaySharedSolutions(); } gameState.hasSharedSolution=true; const button=event.target; const originalText=button.textContent; button.textContent='âœ… Shared with Class!'; button.disabled=true; button.classList.add('opacity-50'); }
    function displaySharedSolutions(){ const display=document.getElementById('classSolutionsDisplay'); if(gameState.sharedSolutions.length===0){ display.innerHTML='<div class="text-center text-purple-500 italic">No solutions shared yet... Complete your mystery to share!</div>'; return; }
        // Group solutions by suspect
        const groupedSolutions = {}; gameState.sharedSolutions.forEach(solution => { if (!groupedSolutions[solution.suspect]) groupedSolutions[solution.suspect] = []; groupedSolutions[solution.suspect].push(solution); });
        display.innerHTML = Object.keys(groupedSolutions).map(suspect => `
                <div class="bg-white p-4 rounded-lg border-2 border-purple-300 mb-4">
                    <h4 class="font-bold text-purple-800 mb-3 text-lg">ğŸ•µï¸ Students who chose: ${suspect}</h4>
                    <div class="space-y-3">
                        ${groupedSolutions[suspect].map((solution, index) => {
                            const isUserSolution = solution.name === localStorage.getItem('userName');
                            return `
                            <div class="p-3 rounded border-l-4 ${isUserSolution ? 'bg-green-50 border-green-400' : 'bg-purple-50 border-purple-400'} ${index === 0 ? 'new-share-notification' : ''}">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="font-semibold ${isUserSolution ? 'text-green-700' : 'text-purple-700'}">ğŸ‘¤ ${solution.name} ${isUserSolution ? '(Your Solution)' : ''}</span>
                                    <span class="text-sm ${isUserSolution ? 'text-green-600' : 'text-purple-600'}">${solution.displayTime}</span>
                                </div>
                                <p class="${isUserSolution ? 'text-green-800' : 'text-purple-800'} text-sm font-medium">ğŸ’­ ${solution.reasoning}</p>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `).join('');
    }
    </script>

    <!-- Removed stray Cloudflare challenge script injected by some hosts -->
</body>
</html>
